name: Build, Test & Deploy to IONOS

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests with Coverage
        run: npm test -- --no-watch --code-coverage --browsers=ChromeHeadless

      - name: ğŸ“Š Generate Coverage Badge
        run: |
          COVERAGE=$(grep -oP 'Lines\s*:\s*\K[\d.]+' coverage/portfolio/index.html | head -1 || echo "0")
          echo "Coverage: $COVERAGE%"
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: ğŸ“š Generate TypeDoc Documentation
        run: npm run docs
        continue-on-error: true

      - name: ğŸ—ï¸ Build Production
        run: npm run build -- --configuration production

      - name: ğŸ“ Prepare Deployment Structure
        run: |
          mkdir -p deploy
          cp -r dist/portfolio/browser/* deploy/
          cp -r coverage/portfolio deploy/coverage
          cp -r docs deploy/jsdoc

          # Create .htaccess for deployment
          cat > deploy/.htaccess << 'EOF'
          # ------------------------------------------------------
          # ğŸ” Apache Configuration for Angular SPA
          # ------------------------------------------------------
          RewriteEngine On

          # ------------------------------------------------------
          # ğŸ”’ Force HTTPS
          # ------------------------------------------------------
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # ------------------------------------------------------
          # ğŸ“Š Static Documentation Folders - Don't redirect
          # ------------------------------------------------------
          RewriteRule ^(coverage|jsdoc)($|/) - [L,NC]

          # ------------------------------------------------------
          # ğŸ›¡ï¸ API Routes Protection - Don't redirect to index.html
          # ------------------------------------------------------
          RewriteCond %{REQUEST_URI} ^/api/
          RewriteRule . - [L]

          # ------------------------------------------------------
          # âš™ï¸ SPA Routing - Angular Router Fallback
          # ------------------------------------------------------
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteCond %{REQUEST_URI} !^/api/
          RewriteRule . index.html [L]

          # ------------------------------------------------------
          # ğŸš€ Cache Static Assets
          # ------------------------------------------------------
          <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType image/avif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType application/json "access plus 0 seconds"
          </IfModule>

          # ------------------------------------------------------
          # ğŸ” Security Headers
          # ------------------------------------------------------
          <IfModule mod_headers.c>
            Header always set X-Content-Type-Options nosniff
            Header always set X-Frame-Options DENY
            Header always set X-XSS-Protection "1; mode=block"
            Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
            Header unset Server
          </IfModule>
          EOF

      - name: ğŸ“¤ Deploy to IONOS via SFTP
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: Dylan700/sftp-upload-action@v1.1.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 22
          uploads: |
            ./deploy/ => ./portfolio/
          delete: false

      - name: âœ… Deployment Complete
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ App: https://portfolio.dev2k.org"
          echo "ğŸ“Š Coverage: https://portfolio.dev2k.org/coverage/"
          echo "ğŸ“š Docs: https://portfolio.dev2k.org/jsdoc/"

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Build & Test Successful\n\n- ğŸ§ª Tests: Passed\n- ğŸ“Š Coverage: ${{ env.COVERAGE }}%\n\nReady to merge!`
            })
